{"version":3,"sources":["../src/worker/task/appstream/content-rating.ts"],"names":[],"mappings":";AAAA;;;GAGG;;;;;;;;;;AAEH,mCAAkC;AAClC,+BAA8B;AAC9B,6BAA4B;AAE5B,mCAA+B;AAC/B,kCAA8B;AAE9B,4BAAoC,SAAQ,WAAI;IAAhD;;QAWE;;;;WAIG;QACI,eAAU,GAAG;YAClB,kBAAkB;YAClB,kBAAkB;YAClB,oBAAoB;YACpB,oBAAoB;YACpB,iBAAiB;YACjB,sBAAsB;YACtB,kBAAkB;YAClB,kBAAkB;YAClB,eAAe;YACf,iBAAiB;YACjB,eAAe;YACf,YAAY;YACZ,YAAY;YACZ,mBAAmB;YACnB,kBAAkB;YAClB,cAAc;YACd,gBAAgB;YAChB,oBAAoB;YACpB,gBAAgB;YAChB,yBAAyB;YACzB,aAAa;YACb,aAAa;YACb,cAAc;YACd,iBAAiB;YACjB,iBAAiB;YACjB,kBAAkB;YAClB,gBAAgB;SACjB,CAAA;IAuDH,CAAC;IAjGC;;;;OAIG;IACH,IAAW,IAAI;QACb,OAAO,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,SAAS,EAAE,4BAA4B,EAAE,GAAG,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,UAAU,cAAc,CAAC,CAAA;IAC3H,CAAC;IAqCD;;;;;OAKG;IACU,GAAG;;YACd,MAAM,GAAG,GAAG,MAAM,EAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,CAAA;YACxC,MAAM,CAAC,GAAG,OAAO,CAAC,IAAI,CAAC,GAAG,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,CAAA;YAE9C,MAAM,aAAa,GAAG,CAAC,CAAC,4BAA4B,CAAC,CAAA;YAErD,IAAI,aAAa,CAAC,MAAM,KAAK,CAAC,EAAE;gBAC9B,MAAM,QAAQ,GAAG,IAAI,CAAC,OAAO,CAAC,SAAS,EAAE,4BAA4B,CAAC,CAAA;gBAEtE,MAAM,SAAG,CAAC,QAAQ,CAAC,SAAG,CAAC,KAAK,CAAC,KAAK,EAAE,QAAQ,EAAE;oBAC5C,OAAO,EAAE,IAAI,CAAC,MAAM,CAAC,OAAO;iBAC7B,CAAC,CAAA;aACH;YAED,IAAI,aAAa,CAAC,IAAI,CAAC,MAAM,CAAC,IAAI,IAAI,EAAE;gBACtC,MAAM,QAAQ,GAAG,IAAI,CAAC,OAAO,CAAC,SAAS,EAAE,wBAAwB,CAAC,CAAA;gBAElE,MAAM,SAAG,CAAC,QAAQ,CAAC,SAAG,CAAC,KAAK,CAAC,IAAI,EAAE,QAAQ,EAAE;oBAC3C,OAAO,EAAE,IAAI,CAAC,MAAM,CAAC,OAAO;iBAC7B,CAAC,CAAA;aACH;YAED,MAAM,iBAAiB,GAAG,IAAI,CAAC,UAAU;iBACtC,MAAM,CAAC,CAAC,SAAS,EAAE,EAAE,CAAC,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC,EAAE,SAAS,CAAC,CAAC,CAAA;YAE1D,IAAI,iBAAiB,CAAC,MAAM,GAAG,CAAC,EAAE;gBAChC,MAAM,QAAQ,GAAG,IAAI,CAAC,OAAO,CAAC,SAAS,EAAE,2BAA2B,CAAC,CAAA;gBAErE,MAAM,SAAG,CAAC,QAAQ,CAAC,SAAG,CAAC,KAAK,CAAC,KAAK,EAAE,QAAQ,EAAE;oBAC5C,UAAU,EAAE,iBAAiB;oBAC7B,OAAO,EAAE,IAAI,CAAC,MAAM,CAAC,OAAO;iBAC7B,CAAC,CAAA;aACH;QACH,CAAC;KAAA;IAED;;;;;;OAMG;IACO,YAAY,CAAE,CAAC,EAAE,SAAS;QAClC,MAAM,IAAI,GAAG,CAAC,CAAC,kDAAkD,SAAS,EAAE,CAAC,CAAA;QAE7E,OAAO,CAAC,IAAI,CAAC,MAAM,KAAK,CAAC,CAAC,CAAA;IAC5B,CAAC;CACF;AAnGD,wDAmGC","file":"content-rating.js","sourcesContent":["/**\n * houston/src/worker/task/appstream/content-rating.ts\n * Tests the OARS content rating in appstream files\n */\n\nimport * as cheerio from 'cheerio'\nimport * as fs from 'fs-extra'\nimport * as path from 'path'\n\nimport { Log } from '../../log'\nimport { Task } from '../task'\n\nexport class AppstreamContentRating extends Task {\n\n  /**\n   * Path the appstream file should exist at\n   *\n   * @return {string}\n   */\n  public get path () {\n    return path.resolve(this.worker.workspace, 'package/usr/share/metainfo', `${this.worker.context.nameDomain}.appdata.xml`)\n  }\n\n  /**\n   * All of the OARS content attributes to check for\n   *\n   * @var {string[]}\n   */\n  public attributes = [\n    'violence-cartoon',\n    'violence-fantasy',\n    'violence-realistic',\n    'violence-bloodshed',\n    'violence-sexual',\n    'violence-desecration',\n    'violence-slavery',\n    'violence-worship',\n    'drugs-alcohol',\n    'drugs-narcotics',\n    'drugs-tobacco',\n    'sex-nudity',\n    'sex-themes',\n    'sex-homosexuality',\n    'sex-prostitution',\n    'sex-adultery',\n    'sex-appearance',\n    'language-profanity',\n    'language-humor',\n    'language-discrimination',\n    'social-chat',\n    'social-info',\n    'social-audio',\n    'social-location',\n    'social-contacts',\n    'money-purchasing',\n    'money-gambling'\n  ]\n\n  /**\n   * Runs all the appstream tests\n   *\n   * @async\n   * @return {void}\n   */\n  public async run () {\n    const raw = await fs.readFile(this.path)\n    const $ = cheerio.load(raw, { xmlMode: true })\n\n    const contentRating = $('component > content_rating')\n\n    if (contentRating.length === 0) {\n      const template = path.resolve(__dirname, 'content-rating-required.md')\n\n      throw Log.template(Log.Level.ERROR, template, {\n        storage: this.worker.context\n      })\n    }\n\n    if (contentRating.attr('type') == null) {\n      const template = path.resolve(__dirname, 'content-rating-type.md')\n\n      throw Log.template(Log.Level.WARN, template, {\n        storage: this.worker.context\n      })\n    }\n\n    const missingAttributes = this.attributes\n      .filter((attribute) => !this.hasAttribute($, attribute))\n\n    if (missingAttributes.length > 0) {\n      const template = path.resolve(__dirname, 'content-rating-missing.md')\n\n      throw Log.template(Log.Level.ERROR, template, {\n        attributes: missingAttributes,\n        storage: this.worker.context\n      })\n    }\n  }\n\n  /**\n   * Checks if the given document has an OARS attribute\n   *\n   * @param {Object} $\n   * @param {string} attribute\n   * @return {Boolean}\n   */\n  protected hasAttribute ($, attribute) {\n    const attr = $(`component > content_rating > content_attribute#${attribute}`)\n\n    return (attr.length !== 0)\n  }\n}\n"]}